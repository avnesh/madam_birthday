<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Wishes - Madam</title>
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@500;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">
<script src="assets/libs/typed.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
</head>
<body class="min-h-screen font-poppins">
<nav class="p-4 container mx-auto flex justify-between items-center">
<a href="index.html" class="text-sm">Home</a>
<div class="nav-links space-x-4">
<a href="memories.html">Memories</a>
<a href="funzone.html">Fun Zone</a>
<a href="surprise.html">Surprise</a>
</div>
</nav>


<main class="container mx-auto p-6 text-center">
  <h2 class="script-heading text-4xl">Dear Madam,</h2>
  <div class="mt-6 max-w-3xl mx-auto rounded-xl shadow-lg p-6 fade-in-up typed-message-container">
    <div id="typed" class="text-xl leading-relaxed"></div>
  </div>
  
  <h3 class="script-heading text-2xl mt-10">Choose Your Melody üé∂</h3>
  <div class="mt-4 max-w-lg mx-auto p-4 rounded-xl shadow-lg typed-message-container playlist-container">
      <div id="playlistList" class="space-y-2">
          </div>
  </div>

  <div class="mt-10">
    <a href="funzone.html" class="btn-primary">Next Page: Fun Zone</a>
  </div>
</main>

<footer class="fixed bottom-6 left-1/2 transform -translate-x-1/2">
  <div id="player" class="player">
    <button id="prevTrack" aria-label="Previous" class="btn-secondary">‚èÆ</button>
    <button id="playToggle" aria-label="Play/Pause" class="btn-primary">‚ñ∂</button>
    <button id="nextTrack" aria-label="Next" class="btn-secondary">‚è≠</button>
    <span id="trackName">Loading...</span>
  </div>
</footer>

<audio id="bgAudio" src="assets/music/birthday.mp3"></audio>

<script src="script.js"></script>
<script>
// Typed.js initialization for wishes
const typed = new Typed('#typed', {
strings: [
"Your guidance lights our path, and your smile brightens our days.",
"May your birthday be as graceful and lovely as you are.",
"Wishing you laughter, love, and a year of beautiful memories."
],
typeSpeed: 35,
backSpeed: 10,
backDelay: 1500,
loop: false
});

// Playlist player logic - Centralized and modified for list display
const musicPlayer = {
    playlist: [],
    currentIndex: 0,
    audio: document.getElementById('bgAudio'),
    trackName: document.getElementById('trackName'),
    playBtn: document.getElementById('playToggle'),
    prevBtn: document.getElementById('prevTrack'),
    nextBtn: document.getElementById('nextTrack'),
    playlistList: document.getElementById('playlistList'),
    // Only 'birthday.mp3' is available, mark the others as unavailable
    availableTracks: ['birthday.mp3'], 

    loadTrack(index, autoPlay = true){
      if(index < 0 || index >= this.playlist.length) return;
      this.currentIndex = index;
      const item = this.playlist[this.currentIndex];
      
      const isAvailable = this.availableTracks.includes(item.file);
      
      if(isAvailable) {
          this.audio.src = 'assets/music/' + item.file;
          if (autoPlay) {
              this.play();
          } else {
              window.pauseBackgroundAudio();
          }
      } else {
          this.audio.pause();
          this.audio.src = 'assets/music/birthday.mp3'; // Fallback source to prevent error
          window.pauseBackgroundAudio();
          alert(`Sorry, the file for "${item.title}" is missing! Please upload "assets/music/${item.file}".`);
      }
      
      this.trackName.textContent = item.title;
      sessionStorage.setItem('currentTrackIndex', this.currentIndex);
      this.updatePlaylistUI();
    },

    play(){ 
        const currentTrack = this.playlist[this.currentIndex];
        if (currentTrack && this.availableTracks.includes(currentTrack.file)) {
             window.playBackgroundAudio();
        }
    },

    pause(){ 
        window.pauseBackgroundAudio();
    },

    updatePlaylistUI() {
        if(!this.playlistList || !this.playlist.length) return;
        
        const isCurrentlyPlaying = !this.audio.paused && sessionStorage.getItem('bgPlaying') === '1';
        
        this.playlistList.innerHTML = '';
        this.playlist.forEach((item, index) => {
            const div = document.createElement('div');
            const isActive = index === this.currentIndex;
            const isPlaying = isActive && isCurrentlyPlaying;
            const isAvailable = this.availableTracks.includes(item.file);
            
            let classList = 'playlist-item';
            if(isActive) classList += ' active';
            if(!isAvailable) classList += ' unavailable-track';

            div.className = classList;
            
            let icon = isPlaying ? '&#x25B6;' : (isAvailable ? '&#x1F3B5;' : '&#x1F6AB;');
            
            div.innerHTML = `<span class="play-icon">${icon}</span>${item.title}`;
            
            div.onclick = () => {
                if(!isAvailable) {
                    alert(`Sorry, the file for "${item.title}" is missing!`);
                    return;
                }
                
                if (index === this.currentIndex) {
                    this.audio.paused ? this.play() : this.pause();
                } else {
                    this.loadTrack(index);
                }
            };
            this.playlistList.appendChild(div);
        });
    },

    bindEvents() {
        this.playBtn.addEventListener('click', () => { 
            this.audio.paused ? this.play() : this.pause();
            this.updatePlaylistUI();
        });
        
        this.prevBtn.addEventListener('click', () => {
          this.loadTrack((this.currentIndex - 1 + this.playlist.length) % this.playlist.length);
        });
        
        this.nextBtn.addEventListener('click', () => {
          this.loadTrack((this.currentIndex + 1) % this.playlist.length);
        });

        this.audio.addEventListener('ended', () => {
          this.loadTrack((this.currentIndex + 1) % this.playlist.length);
        });

        this.audio.addEventListener('play', () => this.updatePlaylistUI());
        this.audio.addEventListener('pause', () => this.updatePlaylistUI());
        this.audio.addEventListener('loadedmetadata', () => this.updatePlaylistUI());
    },

    async loadPlaylist() {
      try {
        const response = await fetch('assets/music/playlist.json');
        this.playlist = await response.json();
        
        const savedIndex = sessionStorage.getItem('currentTrackIndex');
        let initialIndex = 0;
        if (savedIndex !== null && !isNaN(parseInt(savedIndex)) && parseInt(savedIndex) < this.playlist.length) {
            initialIndex = parseInt(savedIndex);
        }
        
        const wasPlaying = sessionStorage.getItem('bgPlaying') === '1';

        if (this.playlist.length > 0) {
          this.loadTrack(initialIndex, wasPlaying);
        } else {
            this.trackName.textContent = 'No Playlist Found';
            this.updatePlaylistUI();
        }

      } catch (error) {
        this.trackName.textContent = 'Error fetching playlist';
        this.updatePlaylistUI();
      }
    },
    
    init() {
        this.loadPlaylist();
        this.bindEvents();
    }
};

document.addEventListener('DOMContentLoaded', ()=>{
  musicPlayer.init();
});
</script>
</body>
</html>